

<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.4. Comvolution / Pooling レイヤの実装 &mdash; まんてらスタジオ輪読会 - ゼロから作るDeep Learning ――Pythonで学ぶディープラーニングの理論と実装 0.0.1 ドキュメント</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="8.5. CNNの実装" href="5.%20Implement-CNN.html" />
    <link rel="prev" title="8.3. プーリング層" href="3.%20Pooling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> まんてらスタジオ輪読会 - ゼロから作るDeep Learning ――Pythonで学ぶディープラーニングの理論と実装
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0.Intro/index.html">1. はじめに</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.Chapter-1/index.html">2. 1章 Python入門</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.Chapter-2/index.html">3. 2章 パーセプトロン</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3.Chapter-3/index.html">4. 3章 ニューラルネットワーク</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4.Chapter-4/index.html">5. 4章 ニューラルネットワークの学習</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.Chapter-5/index.html">6. 5章 誤差伝搬法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.Chapter-6/index.html">7. ６章 学習に関するテクニック</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">8. 7章 畳み込みニューラルネットワーク</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1.Convolutional-neural-network.html">8.1. CNN全体の構造</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.Convolutional.html">8.2. 畳み込み層</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.%20Pooling.html">8.3. プーリング層</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.4. Comvolution / Pooling レイヤの実装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#4次元配列">8.4.1. 4次元配列</a></li>
<li class="toctree-l3"><a class="reference internal" href="#im2colによる展開">8.4.2. im2colによる展開</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Convolution-レイヤの実装">8.4.3. Convolution レイヤの実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Poolingレイヤの実装">8.4.4. Poolingレイヤの実装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="5.%20Implement-CNN.html">8.5. CNNの実装</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.%20CNN-visualize.html">8.6. CNNの可視化</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">まんてらスタジオ輪読会 - ゼロから作るDeep Learning ――Pythonで学ぶディープラーニングの理論と実装</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">8. </span>7章 畳み込みニューラルネットワーク</a> &raquo;</li>
        
      <li><span class="section-number">8.4. </span>Comvolution / Pooling レイヤの実装</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/7.Chapter-7/4.Implement-Convolutional-Pooling.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Comvolution-/-Pooling-レイヤの実装">
<h1><span class="section-number">8.4. </span>Comvolution / Pooling レイヤの実装<a class="headerlink" href="#Comvolution-/-Pooling-レイヤの実装" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="4次元配列">
<h2><span class="section-number">8.4.1. </span>4次元配列<a class="headerlink" href="#4次元配列" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">)))</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span> <span class="c1"># ランダムにデータを生成</span>
<span class="n">x</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(10, 1, 28, 28)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># 1つ目のデータにアクセス</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 28, 28)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># 2つ目のデータにアクセス</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 28, 28)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># 1つ目のデータの、1チャンネル目の空間データにアクセス</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[7.46455120e-01, 2.27963876e-01, 8.27426402e-01, 8.26803413e-01,
        8.60531394e-01, 5.11418231e-01, 5.27047620e-01, 7.03399015e-01,
        7.32704811e-02, 1.09308993e-01, 8.15014474e-01, 3.14114566e-01,
        9.24025136e-01, 2.80541838e-01, 6.79584986e-03, 1.10792427e-01,
        4.48246393e-01, 8.82760812e-02, 9.05718234e-01, 7.86133933e-01,
        2.55209058e-01, 5.22796916e-01, 7.02683868e-01, 1.94566704e-01,
        6.36620563e-01, 5.16364544e-01, 3.03474860e-01, 2.11320952e-01],
       [4.03951927e-01, 1.87770854e-01, 5.80080664e-01, 8.34256457e-01,
        9.39314094e-01, 2.45657250e-01, 8.65530830e-01, 9.20854345e-01,
        1.56331998e-01, 7.62897476e-01, 8.67818851e-01, 3.70141368e-01,
        2.84505630e-01, 3.78607312e-01, 5.58315978e-01, 9.20036356e-01,
        2.58880224e-01, 9.56287150e-01, 2.20749950e-01, 6.86061026e-01,
        1.04820287e-01, 4.47132139e-01, 7.62985191e-01, 8.12218572e-01,
        3.59674603e-01, 2.05085311e-01, 8.31086229e-01, 9.64650123e-01],
       [5.28956298e-01, 5.52748122e-01, 4.79920791e-01, 2.81148690e-01,
        4.35900769e-01, 6.95021156e-01, 4.86216713e-01, 1.22245813e-01,
        8.62867648e-01, 4.40538693e-01, 9.72116112e-01, 3.63611287e-02,
        9.14045729e-01, 5.19092159e-01, 9.72350122e-01, 7.63945661e-01,
        3.55482099e-01, 6.53232699e-01, 8.65791529e-01, 3.22821152e-01,
        2.62456741e-01, 6.63374157e-01, 4.10376090e-01, 4.24009667e-01,
        9.87274223e-01, 4.62407377e-02, 6.56456496e-01, 3.13730495e-01],
       [7.18606295e-01, 9.10762806e-01, 5.00487368e-02, 8.09228955e-01,
        5.67282967e-01, 9.33370771e-02, 1.98947330e-01, 1.62631070e-01,
        6.00090613e-01, 2.49121534e-01, 1.14705218e-01, 5.26247066e-01,
        4.25716715e-01, 3.90532401e-01, 7.46411969e-01, 5.01446742e-01,
        5.86019162e-01, 3.41213168e-01, 9.69051708e-01, 3.29134806e-02,
        7.34018633e-01, 1.93056492e-01, 1.93553843e-01, 2.23852431e-01,
        6.96258639e-01, 4.11262792e-01, 2.28029398e-01, 5.22302539e-01],
       [4.23475670e-01, 1.65699557e-01, 2.96014552e-01, 1.94950327e-01,
        2.35840055e-01, 8.02136570e-01, 6.36881297e-01, 5.18361323e-01,
        7.30289280e-01, 9.34376772e-01, 6.46827533e-01, 4.38049502e-01,
        6.29735765e-01, 2.87765802e-01, 9.15467672e-01, 6.16203016e-01,
        6.13656954e-01, 9.95022410e-01, 3.79982610e-01, 5.71789728e-01,
        5.86652106e-01, 1.46933247e-01, 2.31418917e-01, 4.79836605e-01,
        7.57234727e-01, 9.93779261e-02, 2.31958748e-01, 7.50149019e-01],
       [6.82747995e-01, 2.30982281e-01, 4.16005629e-02, 5.88359095e-01,
        9.33558150e-01, 7.17475803e-01, 1.24411547e-01, 6.99189586e-01,
        5.88954457e-01, 8.13507864e-01, 6.48615165e-01, 2.12180529e-01,
        6.31167147e-01, 1.55236433e-01, 9.29129782e-01, 4.68010480e-01,
        6.13947997e-01, 7.93487018e-01, 7.86107201e-01, 9.50296398e-01,
        4.68254118e-01, 5.67975773e-01, 2.75214473e-01, 2.27449385e-01,
        5.01343857e-01, 2.16418773e-01, 7.74640074e-01, 2.07921267e-01],
       [3.58466076e-01, 9.13461301e-01, 7.59217891e-02, 3.64101937e-01,
        2.70674137e-01, 7.04886786e-01, 4.85662499e-01, 5.37670004e-01,
        1.53445784e-01, 6.09000782e-01, 5.69970931e-01, 9.59354251e-01,
        9.22195823e-01, 1.14199247e-01, 8.26350814e-01, 6.61703847e-01,
        1.60396802e-01, 4.06424995e-01, 9.54833517e-01, 6.03657240e-01,
        2.33391729e-01, 4.01521639e-01, 3.22540182e-01, 2.30126023e-01,
        2.61640163e-01, 6.32554921e-01, 4.41241830e-01, 2.59691392e-01],
       [8.33443576e-01, 1.37501556e-01, 6.97651779e-01, 3.54500895e-01,
        5.84440652e-01, 9.35578521e-01, 7.18540080e-01, 9.15061370e-01,
        9.56877762e-01, 2.95650963e-01, 2.99195464e-01, 1.26332294e-01,
        3.52259685e-01, 4.19420867e-01, 4.42227497e-01, 2.92890827e-01,
        6.73741634e-01, 4.15804942e-01, 7.92465504e-01, 9.71236774e-01,
        3.57554181e-01, 6.94313630e-01, 3.26568391e-01, 6.46365892e-01,
        7.07729163e-01, 7.09206960e-01, 7.75490307e-01, 4.21483438e-01],
       [8.14915163e-03, 5.17055862e-01, 4.39072422e-01, 8.49363548e-01,
        3.14305426e-02, 2.32023646e-01, 9.61729849e-01, 1.65631730e-01,
        7.63607241e-01, 7.40085716e-02, 3.43271602e-02, 4.43440555e-01,
        9.41311324e-01, 9.98836578e-01, 3.44661035e-01, 7.14372472e-01,
        8.98675041e-02, 5.76569855e-01, 8.54737696e-01, 7.49008869e-01,
        1.56247113e-01, 6.55426268e-01, 6.24778850e-01, 6.10067145e-01,
        4.27663835e-01, 1.37521906e-01, 4.88969758e-01, 8.02401202e-01],
       [8.86015600e-01, 5.01397989e-01, 5.90601229e-02, 8.65306596e-01,
        4.27583666e-01, 1.51195036e-01, 4.71110749e-02, 9.85532894e-01,
        6.14647733e-01, 6.32465831e-01, 3.28685744e-01, 2.93326353e-01,
        6.51783237e-01, 4.87892684e-01, 2.14292299e-01, 6.07874852e-01,
        9.31987762e-01, 7.43693241e-01, 7.28212503e-01, 6.50320583e-01,
        6.47876303e-01, 4.00688742e-02, 3.14540384e-01, 9.96390996e-01,
        4.60466245e-01, 1.78761983e-01, 4.22862838e-02, 6.19093258e-01],
       [9.51484168e-01, 6.87546923e-01, 3.61576240e-01, 9.04298962e-01,
        4.69256161e-01, 9.04771944e-01, 1.94895147e-01, 4.06794905e-01,
        1.99110372e-01, 4.31780007e-01, 4.16901194e-01, 7.98212619e-02,
        7.19721372e-01, 7.49251099e-01, 8.45644922e-01, 1.41772809e-01,
        1.05602287e-01, 6.69576440e-02, 6.28086657e-01, 6.16504993e-01,
        8.61918093e-01, 2.35597159e-01, 6.92240310e-01, 2.42599478e-01,
        5.77458851e-01, 6.39502674e-01, 1.00905682e-01, 9.13104018e-01],
       [4.84151537e-01, 1.47566455e-01, 7.23894307e-01, 8.32892863e-01,
        9.45434932e-01, 8.32320799e-01, 6.76105737e-01, 5.79858742e-01,
        1.19561335e-01, 2.70875589e-02, 1.81584326e-01, 3.86005149e-01,
        9.11250426e-01, 8.14528602e-01, 6.52829314e-01, 2.95412580e-01,
        6.83016162e-01, 6.16147171e-01, 4.14563219e-04, 6.15367620e-01,
        8.23406599e-02, 1.92954798e-01, 9.68460770e-01, 4.75632089e-01,
        2.72164760e-01, 9.37508463e-01, 8.33939601e-01, 5.71895402e-01],
       [8.24197041e-01, 5.06285575e-01, 8.66060624e-01, 4.45276569e-03,
        7.85483618e-02, 9.64055843e-01, 8.23314108e-01, 9.07433479e-01,
        6.38287109e-01, 8.16646323e-01, 6.83621283e-01, 1.35911722e-02,
        1.14781164e-01, 1.04495873e-01, 3.64866295e-02, 4.14716225e-01,
        5.60912032e-02, 6.47171268e-01, 8.40610775e-01, 9.62700512e-01,
        7.06501458e-02, 8.25360600e-01, 7.62349703e-01, 8.26256597e-01,
        4.43647025e-01, 3.25188836e-01, 7.29252270e-01, 8.88779579e-01],
       [5.72501121e-01, 6.87171452e-01, 6.90831498e-01, 3.55823391e-01,
        8.28055797e-01, 3.69172604e-01, 2.74057542e-01, 9.18860834e-02,
        2.16264888e-01, 9.52469910e-02, 6.66412171e-01, 4.93963517e-01,
        7.19060568e-01, 9.70385890e-01, 8.55261763e-02, 7.17406599e-02,
        2.68435031e-01, 7.61333140e-01, 4.25854845e-01, 3.97499868e-01,
        7.52547205e-01, 2.41306161e-01, 2.53409801e-01, 4.03980564e-01,
        3.84571924e-01, 5.91608123e-01, 4.62163291e-01, 7.49126877e-01],
       [9.25316754e-01, 9.23039112e-01, 8.71130809e-02, 9.36325716e-01,
        9.95759487e-01, 1.19317067e-01, 3.16613508e-01, 7.78033316e-01,
        4.00319805e-01, 4.45151894e-01, 9.31948346e-01, 6.02004659e-01,
        4.89465719e-01, 8.55296974e-01, 6.82682328e-02, 6.69848190e-01,
        6.97620674e-02, 2.26382602e-01, 6.48364301e-01, 3.12417911e-02,
        2.07617937e-01, 6.58064313e-01, 9.91172575e-01, 5.77215712e-01,
        1.44586353e-01, 4.06569044e-01, 5.82562135e-01, 5.18761125e-01],
       [1.39701323e-01, 5.33849445e-01, 1.78333341e-02, 7.36128529e-01,
        6.21878345e-01, 3.52825186e-01, 5.36497500e-03, 1.26344083e-01,
        4.45264773e-01, 4.71438644e-01, 3.32636427e-01, 3.54839822e-01,
        9.37085984e-01, 1.71536560e-01, 2.13848610e-02, 5.55817934e-01,
        7.90145246e-01, 1.31151994e-01, 2.98448043e-01, 4.94604124e-01,
        9.43620343e-01, 5.35602472e-02, 3.16143949e-01, 1.74964831e-01,
        7.19499720e-01, 1.31382913e-01, 7.60031899e-02, 5.66504602e-01],
       [1.56467006e-01, 4.71481487e-01, 4.13741235e-01, 2.41054872e-01,
        3.87437537e-01, 6.51896773e-02, 6.07919911e-01, 4.66169349e-01,
        6.50662995e-01, 9.81575207e-03, 3.19298200e-01, 9.67503877e-01,
        4.52597496e-03, 1.65415847e-01, 7.67148083e-01, 1.95315427e-01,
        4.26667194e-01, 6.61384978e-01, 2.77242372e-01, 5.95361187e-01,
        8.10458079e-01, 1.67760315e-01, 3.78285960e-01, 8.35850786e-02,
        7.40909903e-01, 9.07375069e-01, 1.44170694e-01, 5.15366144e-01],
       [7.49555829e-03, 5.11959771e-01, 2.85293564e-01, 6.64528004e-01,
        8.62378006e-01, 4.71103873e-02, 4.54527113e-01, 7.96920477e-01,
        5.10112624e-01, 9.25747312e-01, 7.38245639e-01, 1.29147742e-01,
        5.66681941e-01, 2.59535327e-01, 4.00606474e-01, 4.55794248e-01,
        6.12936597e-01, 7.80401311e-01, 9.34560912e-01, 5.03399736e-01,
        5.96915325e-01, 1.41315992e-02, 2.79090593e-01, 3.37042978e-01,
        9.20900064e-01, 8.74347084e-03, 6.94411881e-01, 1.59258232e-02],
       [6.41399526e-01, 3.62281841e-01, 4.60624445e-01, 3.46285018e-01,
        9.99380558e-01, 8.61930205e-01, 8.53832245e-01, 5.57079181e-01,
        3.47734927e-01, 1.13003939e-01, 6.80945107e-01, 4.60689749e-01,
        1.62382832e-01, 9.31673595e-01, 2.48753653e-01, 6.52301224e-01,
        7.35557585e-01, 7.13339367e-01, 8.41276782e-01, 6.06089795e-01,
        5.38195803e-01, 8.01575372e-02, 1.77487439e-01, 8.23636477e-01,
        5.57477258e-01, 3.88232770e-02, 9.62549655e-01, 1.92759082e-01],
       [8.95211127e-01, 5.85759221e-01, 7.41528444e-02, 7.95912051e-01,
        5.28049254e-01, 1.12707108e-01, 1.29677564e-01, 1.53757394e-01,
        6.70237211e-01, 6.37532201e-01, 1.17483989e-01, 8.12396578e-01,
        6.66003608e-01, 9.98811030e-02, 9.84756276e-01, 1.60092791e-01,
        6.32020017e-01, 6.02422379e-01, 5.27858455e-02, 3.73056931e-01,
        6.76505665e-01, 5.70869394e-01, 5.39477126e-01, 4.65371437e-01,
        3.10655539e-01, 7.42982786e-03, 9.40493771e-01, 8.41843487e-01],
       [5.51324343e-01, 9.71110641e-01, 5.90230831e-01, 8.13148645e-01,
        4.27976073e-01, 5.56336557e-01, 1.14200120e-01, 9.06750620e-01,
        6.06534111e-01, 6.29953377e-01, 7.72502297e-01, 7.79928307e-01,
        3.31396467e-01, 6.16598091e-01, 5.74269671e-01, 9.21892328e-01,
        4.81680161e-01, 9.63003253e-01, 8.61772631e-02, 4.24563847e-01,
        2.65460961e-01, 8.81578303e-01, 3.69491498e-01, 7.90004429e-01,
        7.47649224e-01, 6.27816654e-01, 8.56111462e-01, 7.33647893e-01],
       [7.93071000e-01, 9.39395190e-01, 8.06050527e-01, 2.46194564e-01,
        1.61274892e-01, 9.52770249e-01, 6.79299926e-01, 8.16650765e-01,
        1.69010824e-01, 8.81568644e-01, 4.74255451e-01, 9.14069211e-01,
        2.14361846e-01, 3.71657844e-01, 3.88492542e-01, 3.27328445e-01,
        1.66717286e-01, 9.34844246e-02, 6.18202260e-01, 5.30945134e-01,
        3.91600230e-01, 5.43912342e-01, 4.61725734e-01, 1.66011244e-01,
        4.77644354e-01, 9.99968315e-01, 2.92467773e-01, 7.06248658e-01],
       [3.55233392e-01, 6.61529015e-01, 3.45724792e-01, 7.35879313e-01,
        3.13486359e-01, 8.89689578e-01, 2.88355462e-01, 4.67812371e-01,
        3.42406207e-01, 1.54923541e-01, 1.71601436e-02, 9.06808621e-01,
        6.26267702e-01, 8.46050504e-01, 4.97191957e-01, 4.42864747e-01,
        5.51167422e-01, 7.37057800e-01, 6.47698534e-01, 6.78910403e-02,
        1.92058568e-01, 3.89085151e-01, 9.34290783e-01, 7.08902162e-01,
        5.64528391e-01, 5.23889856e-01, 1.03287484e-01, 5.64184354e-01],
       [2.05301385e-01, 1.33711294e-01, 4.50556811e-01, 3.80711564e-01,
        4.40834009e-01, 8.15779833e-01, 3.91492425e-01, 2.27680537e-01,
        5.19823039e-01, 5.19845330e-02, 8.16212104e-01, 7.64287820e-01,
        7.54757569e-01, 8.65711656e-01, 3.69304766e-01, 6.49056286e-01,
        9.57079183e-02, 4.45317716e-02, 7.92986942e-01, 7.65407464e-01,
        5.53620957e-01, 5.97657478e-01, 7.53313072e-01, 1.31745145e-01,
        6.11002149e-01, 8.21139387e-01, 5.20170600e-01, 1.92531292e-01],
       [2.48764504e-01, 8.57158462e-01, 1.60636772e-01, 9.36213070e-01,
        4.85975137e-01, 6.43898513e-01, 5.08286137e-02, 3.04333012e-02,
        2.03940063e-01, 8.70897901e-01, 4.81609409e-01, 6.15979279e-01,
        8.61882806e-01, 3.43366836e-01, 4.39118719e-01, 7.19994211e-01,
        5.23686672e-01, 5.32908196e-01, 2.29339751e-01, 5.80869441e-01,
        4.46953617e-02, 4.21767573e-01, 8.26056443e-01, 1.12113206e-01,
        9.70801973e-01, 9.28865112e-01, 4.90708466e-01, 2.16601219e-01],
       [9.16337738e-01, 8.96942002e-01, 2.90703863e-01, 1.85660447e-01,
        2.26900348e-01, 4.13983007e-01, 2.69570598e-01, 2.88570991e-01,
        2.78554594e-01, 4.19120959e-01, 2.54393111e-01, 7.02132445e-01,
        7.35633139e-01, 7.43792127e-01, 2.97035809e-01, 3.37200462e-01,
        4.37576240e-01, 3.68025116e-01, 1.99905348e-01, 1.73117211e-01,
        2.40863480e-01, 2.62601807e-02, 8.53133932e-01, 5.22292208e-01,
        6.42894472e-01, 4.29176565e-01, 4.14385911e-01, 3.05540051e-01],
       [9.73592820e-01, 9.15234502e-01, 1.64450167e-01, 5.58369077e-03,
        7.16045055e-02, 7.42231006e-01, 3.66223842e-01, 7.31008433e-01,
        4.85227212e-01, 5.07172860e-02, 5.26328427e-01, 2.14019661e-01,
        3.56974984e-01, 8.06161037e-01, 7.08070836e-01, 7.50775252e-01,
        2.64836881e-01, 9.84340330e-01, 5.42772514e-01, 4.93113767e-01,
        5.20820336e-01, 5.30817789e-01, 5.62515927e-02, 4.76085351e-01,
        8.25129849e-01, 6.98940576e-01, 5.21246816e-01, 3.22277406e-01],
       [5.44108028e-01, 1.01284146e-01, 9.22323594e-01, 2.24490182e-01,
        2.51889361e-01, 8.27815687e-01, 3.32006987e-01, 6.28728377e-02,
        5.09628768e-02, 2.79569256e-01, 7.56242927e-01, 4.44651964e-01,
        6.85801870e-02, 8.05050096e-01, 2.43117627e-02, 4.94562512e-01,
        9.57729021e-01, 6.47568055e-02, 3.96393700e-01, 2.90967161e-02,
        3.48168205e-01, 6.79447073e-01, 4.05632771e-03, 4.20028183e-01,
        3.02600544e-01, 3.55424447e-01, 5.13069265e-01, 9.94934160e-01]])
</pre></div></div>
</div>
</div>
<div class="section" id="im2colによる展開">
<h2><span class="section-number">8.4.2. </span>im2colによる展開<a class="headerlink" href="#im2colによる展開" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p>NumPyでは、<code class="docutils literal notranslate"><span class="pre">for</span></code>分を使うと処理が遅くなってしまう</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span></code>分を使わず、<code class="docutils literal notranslate"><span class="pre">im2col</span></code>を使う</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">im2col</span></code>は image to columnの略、「画像から行列へ」</p>
</div>
<div class="section" id="Convolution-レイヤの実装">
<h2><span class="section-number">8.4.3. </span>Convolution レイヤの実装<a class="headerlink" href="#Convolution-レイヤの実装" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">)))</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">common.util</span> <span class="kn">import</span> <span class="n">im2col</span>

<span class="c1"># パッチサイズが1, チャンネル3の 7x7のデータ</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">col1</span> <span class="o">=</span> <span class="n">im2col</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;col1.shape: </span><span class="si">{</span><span class="n">col1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># パッチサイズが10, チャンネル3の 7x7のデータ</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">col2</span> <span class="o">=</span> <span class="n">im2col</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;col2.shape: </span><span class="si">{</span><span class="n">col2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
col1.shape: (9, 75)
col2.shape: (90, 75)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Comvolution</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    畳み込み層</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pad</span>

        <span class="c1"># 中間データ（backward時に使用）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_W</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 重み・バイアスパラメータの勾配</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dW</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        順伝搬</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FN</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">FH</span><span class="p">,</span> <span class="n">FW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">out_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">-</span> <span class="n">FH</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span> <span class="c1"># 出力データの縦幅</span>
        <span class="n">out_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">-</span> <span class="n">FW</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span> <span class="c1"># 出力データの横幅</span>

        <span class="n">col</span> <span class="o">=</span> <span class="n">im2col</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">FH</span><span class="p">,</span> <span class="n">FW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span> <span class="c1"># 入力データの展開</span>
        <span class="n">col_W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>               <span class="c1"># フィルターを2次元に展開</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col_W</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>              <span class="c1"># 展開した行列の籍を計算</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">out_h</span><span class="p">,</span> <span class="n">out_w</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_W</span> <span class="o">=</span> <span class="n">col_W</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        逆伝搬</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FN</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">FH</span><span class="p">,</span> <span class="n">FW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">dout</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FN</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dout</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dW</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">FN</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">FH</span><span class="p">,</span> <span class="n">FW</span><span class="p">)</span>

        <span class="n">dcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_W</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">col2im</span><span class="p">(</span><span class="n">dcol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">FH</span><span class="p">,</span> <span class="n">FW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dx</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Poolingレイヤの実装">
<h2><span class="section-number">8.4.4. </span>Poolingレイヤの実装<a class="headerlink" href="#Poolingレイヤの実装" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Pooling</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    プーリング層</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_h</span><span class="p">,</span> <span class="n">pool_w</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span> <span class="o">=</span> <span class="n">pool_h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span> <span class="o">=</span> <span class="n">pool_w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pad</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        順伝搬</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">out_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span> <span class="c1"># 出力データの縦幅</span>
        <span class="n">out_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span> <span class="c1"># 出力データの横幅</span>

        <span class="c1"># 入力データの展開</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">im2col</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">)</span>

        <span class="c1"># 行ごとに最大値をとる</span>
        <span class="n">arg_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 適切な出力サイズに整形する</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">out_h</span><span class="p">,</span> <span class="n">out_w</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span> <span class="o">=</span> <span class="n">arg_max</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        逆伝搬</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">dout</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">pool_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dout</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">))</span>
        <span class="n">dmax</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span> <span class="o">=</span> <span class="n">dout</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dout</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">pool_size</span><span class="p">,))</span>

        <span class="n">dcol</span> <span class="o">=</span> <span class="n">dmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">col2im</span><span class="p">(</span><span class="n">dcol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dx</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">)))</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">common.util</span> <span class="kn">import</span> <span class="n">im2col</span>
<span class="kn">from</span> <span class="nn">common.util</span> <span class="kn">import</span> <span class="n">col2im</span>

<span class="k">class</span> <span class="nc">Pooling</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    プーリング層</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool_h</span><span class="p">,</span> <span class="n">pool_w</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span> <span class="o">=</span> <span class="n">pool_h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span> <span class="o">=</span> <span class="n">pool_w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pad</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        順伝搬</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">out_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span> <span class="c1"># 出力データの縦幅</span>
        <span class="n">out_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">)</span> <span class="c1"># 出力データの横幅</span>

        <span class="c1"># 入力データの展開</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">im2col</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">)</span>

        <span class="c1"># 行ごとに最大値をとる</span>
        <span class="n">arg_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 適切な出力サイズに整形する</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">out_h</span><span class="p">,</span> <span class="n">out_w</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span> <span class="o">=</span> <span class="n">arg_max</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        逆伝搬</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">dout</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">pool_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dout</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">))</span>
        <span class="n">dmax</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_max</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span> <span class="o">=</span> <span class="n">dout</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----reshape.1----&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dmax.shape: </span><span class="si">{</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dout.shape: </span><span class="si">{</span><span class="n">dout</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(pool_size,): </span><span class="si">{</span><span class="p">(</span><span class="n">pool_size</span><span class="p">,)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">dmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dout</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">pool_size</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dmax.shape: </span><span class="si">{</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----reshape.2----&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dmax.shape[0]: </span><span class="si">{</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dmax.shape[1]: </span><span class="si">{</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dmax.shape[2]: </span><span class="si">{</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dcol</span> <span class="o">=</span> <span class="n">dmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dmax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dcol.shape: </span><span class="si">{</span><span class="n">dcol</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">col2im</span><span class="p">(</span><span class="n">dcol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dx</span>

<span class="n">pool</span> <span class="o">=</span> <span class="n">Pooling</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x.shape: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">dout</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dout.shape: </span><span class="si">{</span><span class="n">dout</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="n">inX</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">dout</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inX.shape: </span><span class="si">{</span><span class="n">inX</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
x.shape: (1, 2, 16, 32)

dout.shape: (1, 2, 8, 16)

----reshape.1----
dmax.shape: (256, 4)
dout.shape: (1, 8, 16, 2)
(pool_size,): (4,)
dmax.shape: (1, 8, 16, 2, 4)
----reshape.2----
dmax.shape[0]: 1
dmax.shape[1]: 8
dmax.shape[2]: 16
dcol.shape: (128, 8)
inX.shape: (1, 2, 16, 32)
</pre></div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="5.%20Implement-CNN.html" class="btn btn-neutral float-right" title="8.5. CNNの実装" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="3.%20Pooling.html" class="btn btn-neutral float-left" title="8.3. プーリング層" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 著作権 2020, murnana

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>